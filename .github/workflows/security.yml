name: Security & Supply Chain

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: "17 03 * * 2"

permissions:
  contents: read

jobs:
  pip-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
      - name: Run pip-audit (SARIF)
        run: |
          source_label="environment"
          if [ -s requirements.txt ]; then
            pip install -r requirements.txt
            pip-audit -r requirements.txt -f json -o pip-audit.json || true
            source_label="requirements.txt"
          else
            pip-audit -f json -o pip-audit.json || true
          fi
          python scripts/pip_audit_to_sarif.py pip-audit.json pip-audit.sarif --source "$source_label"
      - name: Upload pip-audit SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: pip-audit.sarif
  bandit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml]
      - name: Run bandit (SARIF)
        run: |
          bandit -r bst -f sarif -o bandit.sarif || true
          if [ ! -s bandit.sarif ]; then
            printf '%s\n' '{"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"bandit","rules":[]}},"results":[]}]}'> bandit.sarif
          fi
      - name: Upload bandit SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: bandit.sarif
  ruff-security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      - name: Run ruff (security rules)
        run: |
          ruff check . --select S,B --output-format sarif --output-file ruff.sarif || true
          if [ ! -s ruff.sarif ]; then
            printf '%s\n' '{"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"ruff","rules":[]}},"results":[]}]}'> ruff.sarif
          fi
      - name: Upload ruff SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ruff.sarif
  codeql:
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v4
        with:
          languages: python
      - uses: github/codeql-action/analyze@v4

  sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install CycloneDX CLI
        run: |
          python -m pip install --upgrade pip
          python -m pip install cyclonedx-bom
      - name: Generate SBOM (CycloneDX JSON v1.4)
        run: |
          cyclonedx-py requirements --spec-version 1.4 --output-format JSON --output-file sbom.json requirements-dev.txt || \
          cyclonedx-py requirements --spec-version 1.4 --output-format JSON --output-file sbom.json requirements.txt
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

  dependency-review:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/dependency-review-action@v4

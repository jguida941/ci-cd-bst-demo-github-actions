name: Security & Supply Chain

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: "17 03 * * 2"

permissions:
  contents: read

jobs:
  pip-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
      - name: Run pip-audit (SARIF)
        run: |
          if [ -s requirements.txt ]; then
            pip install -r requirements.txt
            pip-audit -r requirements.txt -f sarif -o pip-audit.sarif || true
          else
            pip-audit -f sarif -o pip-audit.sarif || true
          fi

          if [ ! -s pip-audit.sarif ]; then
            printf '%s\n' '{"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"pip-audit","rules":[]}},"results":[]}]}'> pip-audit.sarif
          fi
      - name: Upload pip-audit SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit.sarif
  bandit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml]
      - name: Run bandit (SARIF)
        run: |
          bandit -r bst -f sarif -o bandit.sarif || true
          if [ ! -s bandit.sarif ]; then
            printf '%s\n' '{"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"bandit","rules":[]}},"results":[]}]}'> bandit.sarif
          fi
      - name: Upload bandit SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit.sarif
  ruff-security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      - name: Run ruff (security rules)
        run: |
          ruff check . --select S,B --format sarif > ruff.sarif || true
          if [ ! -s ruff.sarif ]; then
            printf '%s\n' '{"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"ruff","rules":[]}},"results":[]}]}'> ruff.sarif
          fi
      - name: Upload ruff SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ruff.sarif
  codeql:
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: python
      - uses: github/codeql-action/analyze@v3

  sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Generate SBOM (CycloneDX JSON v1.4)
        run: |
          curl -s https://raw.githubusercontent.com/CycloneDX/cyclonedx-cli/main/install.sh | bash -s -- -b $HOME/.local/bin
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          cyclonedx --input-type requirements --output-format json --spec-version 1.4 --output sbom.json requirements-dev.txt || \
          cyclonedx --input-type requirements --output-format json --spec-version 1.4 --output sbom.json requirements.txt
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

  dependency-review:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/dependency-review-action@v4

name: Security & Supply Chain

on:
  push:
    branches: [ main ]
  pull_request:
  schedule:
    - cron: "17 03 * * 2"

permissions:
  contents: read

jobs:
  pip-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
      - name: Run pip-audit (SARIF)
        run: |
          if [ -s requirements.txt ]; then
            pip install -r requirements.txt
            pip-audit -r requirements.txt -f sarif -o pip-audit.sarif || true
          else
            pip-audit -f sarif -o pip-audit.sarif || true
          fi

          if [ ! -s pip-audit.sarif ]; then
            printf '%s\n' '{"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"pip-audit","rules":[]}},"results":[]}]}'> pip-audit.sarif
          fi
      - name: Upload pip-audit SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit.sarif
  bandit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml]
      - name: Run bandit (SARIF)
        run: |
          bandit -r bst -f sarif -o bandit.sarif || true
          if [ ! -s bandit.sarif ]; then
            printf '%s\n' '{"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"bandit","rules":[]}},"results":[]}]}'> bandit.sarif
          fi
      - name: Upload bandit SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit.sarif
  ruff-security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      - name: Run ruff (security rules)
        run: |
          ruff check . --select S,B --format sarif > ruff.sarif || true
          if [ ! -s ruff.sarif ]; then
            printf '%s\n' '{"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"ruff","rules":[]}},"results":[]}]}'> ruff.sarif
          fi
      - name: Upload ruff SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ruff.sarif
  codeql:
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: python
      - uses: github/codeql-action/analyze@v3

  sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Generate SBOM (CycloneDX JSON v1.4)
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          def pick_requirements():
              for name in ("requirements-dev.txt", "requirements.txt"):
                  path = Path(name)
                  if path.exists():
                      content = path.read_text().strip()
                      if content:
                          return path
              return None

          req_path = pick_requirements()
          components = []
          if req_path:
              for line in req_path.read_text().splitlines():
                  line = line.strip()
                  if not line or line.startswith("#") or line.startswith("-r"):
                      continue
                  name, version = (line.split("==", 1) + [""])[:2]
                  component = {"type": "library", "name": name}
                  if version:
                      component["version"] = version
                  components.append(component)

          sbom = {
              "bomFormat": "CycloneDX",
              "specVersion": "1.4",
              "version": 1,
              "metadata": {
                  "component": {
                      "type": "application",
                      "name": "binary-search-tree-demo"
                  }
              },
              "components": components,
          }

          Path("sbom.json").write_text(json.dumps(sbom, indent=2) + "\n", encoding="utf-8")
          PY
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

  dependency-review:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/dependency-review-action@v4

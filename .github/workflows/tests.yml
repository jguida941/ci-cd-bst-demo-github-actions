name: Run Unit Tests (BST CI/CD Demo)

on:
  push:
    branches: [ main, fail-demo ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - run: ruff check .

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - env:
          PYTHONPATH: .
        run: mypy bst

  test:
    runs-on: ubuntu-latest
    needs: [ lint, type-check ]
    strategy:
      matrix:
        python-version: [ "3.10" ]
    env:
      MAIL_TO: ${{ secrets.MAIL_TO }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - name: Pytest with coverage
        id: pytest
        env:
          PYTHONPATH: .
        run: |
          set -o pipefail
          mkdir -p reports
          pytest --junitxml=reports/junit.xml | tee reports/pytest.log
          TEST_EXIT=${PIPESTATUS[0]}
          COVERAGE_OK=true
          if [ -f .coverage ]; then
            coverage xml -o reports/coverage.xml || COVERAGE_OK=false
            coverage report --fail-under=95 | tee reports/coverage.txt || COVERAGE_OK=false
          else
            COVERAGE_OK=false
          fi
          echo "test_exit=${TEST_EXIT}" >> "$GITHUB_OUTPUT"
          echo "coverage_ok=${COVERAGE_OK}" >> "$GITHUB_OUTPUT"
          exit ${TEST_EXIT}
        continue-on-error: true
      - name: Build markdown summary
        id: summary
        if: ${{ always() }}
        env:
          COVERAGE_OK: ${{ steps.pytest.outputs.coverage_ok }}
        run: |
          python - <<'PY'
          import os
          from pathlib import Path
          import xml.etree.ElementTree as ET

          junit = Path("reports/junit.xml")
          total = failures = errors = skipped = 0
          if junit.exists():
            root = ET.parse(junit).getroot()
            suites = root.findall(".//testsuite") or ([root] if root.tag == "testsuite" else [])
            for suite in suites:
              total += int(suite.attrib.get("tests", 0))
              failures += int(suite.attrib.get("failures", 0))
              errors += int(suite.attrib.get("errors", 0))
              skipped += int(suite.attrib.get("skipped", 0))
          passed = max(total - failures - errors - skipped, 0)

          coverage_file = Path("reports/coverage.txt")
          coverage_text = coverage_file.read_text(encoding="utf-8").strip() if coverage_file.exists() else "Coverage summary unavailable."
          coverage_status = "PASS Meets threshold" if os.environ.get("COVERAGE_OK") == "true" else "WARN Below threshold or unavailable"

          md = "\n".join([
            "# CI Test Report",
            "",
            f"**Commit:** {os.environ.get('GITHUB_SHA', 'unknown')}",
            f"**Branch:** {os.environ.get('GITHUB_REF_NAME', 'unknown')}",
            "",
            "## Summary",
            f"- Total: **{total}**",
            f"- Passed: **{passed}**",
            f"- Failed: **{failures}**",
            f"- Errors: **{errors}**",
            f"- Skipped: **{skipped}**",
            "",
            "## Coverage",
            f"- Status: {coverage_status}",
            "```",
            coverage_text,
            "```",
            "",
            "## Logs",
            "See attached artifacts for `pytest.log` and `junit.xml`.",
          ])

          Path("reports/report.md").write_text(md, encoding="utf-8")
          cat_summary = Path("reports/report.md").read_text(encoding="utf-8")
          print(cat_summary)
          PY
          cat reports/report.md >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: test-reports-${{ matrix.python-version }}
          path: reports/
      - uses: codecov/codecov-action@v4
        if: ${{ always() && hashFiles('reports/coverage.xml') != '' }}
        with:
          files: reports/coverage.xml
          flags: unit
          fail_ci_if_error: true
      - name: Fail if tests failed
        if: ${{ always() && steps.pytest.outputs.test_exit != '0' }}
        run: |
          echo "Tests failed; see report above."
          exit 1
      - name: Fail if coverage below threshold
        if: ${{ always() && steps.pytest.outputs.coverage_ok != 'true' }}
        run: |
          echo "Coverage threshold not met; see coverage summary above."
          exit 1

  mutation:
    runs-on: ubuntu-latest
    needs: [ test ]
    if: ${{ needs.test.result == 'success' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
      - name: Install mutation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - name: Run mutation tests
        env:
          PYTHONPATH: .
        run: |
          set -o pipefail
          mkdir -p reports
          rm -rf .mutmut-cache
          mutmut run
          mutmut results > reports/mutmut.txt
          cat reports/mutmut.txt
          survivors=$(python -c "from pathlib import Path; import re; text = Path('reports/mutmut.txt').read_text(encoding='utf-8'); match = re.search(r'survived\s+(\d+)', text, re.IGNORECASE); print(match.group(1) if match else '0')")
          if [ "$survivors" != "0" ]; then
            echo "Mutation testing found surviving mutants: $survivors"
            exit 1
          fi
      - uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: reports/mutmut.txt
